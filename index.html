<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYROX COMPARE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkBg: '#050505',
                        darkPanel: '#111111',
                        darkBorder: '#333333',
                        darkHover: '#1a1a1a',
                        lightBg: '#f8fafc',
                        lightPanel: '#ffffff',
                        lightBorder: '#e2e8f0',
                        lightHover: '#f1f5f9',
                        hyroxGold: '#FFD700',
                        rankSilver: '#a1aabf',
                        rankBronze: '#CD7F32'
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Teko:wght@300;400;600;700&family=Roboto:wght@300;400;500;700&display=swap');
        
        :root {
            /* Bar genişliği: 70px'ten %20 artırılarak 84px yapıldı */
            --dyn-col-w: 84px; 
        }

        body { 
            font-family: 'Roboto', sans-serif; 
        }
        .font-sport { font-family: 'Teko', sans-serif; }
        
        /* Özelleştirilmiş Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        .dark ::-webkit-scrollbar-track { background: #050505; }
        .dark ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        html:not(.dark) ::-webkit-scrollbar-track { background: #f8fafc; }
        html:not(.dark) ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        html:not(.dark) ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Mobil tablo başlığı sabitleme */
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 20;
        }

        /* HYROX Tablo Kenarlıkları */
        .hyrox-table-border {
            border-top: 1px solid #FFD700;
            border-bottom: 1px solid #FFD700;
        }

        /* Dinamik Kolon Sınıfı */
        .dyn-col {
            min-width: var(--dyn-col-w);
            width: var(--dyn-col-w);
            max-width: var(--dyn-col-w);
            padding-left: 0.25rem;
            padding-right: 0.25rem;
        }

        /* Bar içi text okunabilirliği için Güçlü Text Shadow */
        .text-outline {
            text-shadow: 0px 1px 3px rgba(0,0,0,0.95), 0px 0px 2px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col p-3 md:p-8 bg-lightBg dark:bg-darkBg text-slate-900 dark:text-white transition-colors duration-300">

    <!-- Üst Menü (Tema ve Dil) -->
    <div class="absolute top-4 right-4 flex gap-2 z-50">
        <button onclick="toggleLang()" class="w-10 h-10 rounded-full bg-lightPanel dark:bg-darkPanel border border-lightBorder dark:border-darkBorder flex items-center justify-center shadow-md hover:scale-105 transition-transform">
            <span id="langBtnText" class="font-bold text-sm text-slate-800 dark:text-gray-200">EN</span>
        </button>
        <button onclick="toggleTheme()" class="w-10 h-10 rounded-full bg-lightPanel dark:bg-darkPanel border border-lightBorder dark:border-darkBorder flex items-center justify-center shadow-md hover:scale-105 transition-transform">
            <i id="themeIcon" class="fas fa-moon text-slate-700 dark:text-hyroxGold"></i>
        </button>
    </div>

    <!-- Başlık -->
    <div class="text-center mb-6 md:mb-8 mt-6 md:mt-2">
        <h1 class="text-5xl md:text-7xl font-sport font-bold text-hyroxGold tracking-wider drop-shadow-lg">
            HYROX <span class="text-slate-900 dark:text-white transition-colors">COMPARE</span>
        </h1>
        <p id="t-subtitle" class="text-slate-500 dark:text-gray-400 text-xs md:text-sm mt-1 font-medium transition-colors">Professional Segment Comparison</p>
    </div>

    <!-- Ana Kontrol Paneli -->
    <div class="max-w-4xl mx-auto w-full mb-6">
        <div class="bg-lightPanel dark:bg-darkPanel p-3 md:p-5 rounded-xl border border-lightBorder dark:border-darkBorder flex flex-col md:flex-row gap-3 items-center shadow-lg transition-colors">
            <div class="flex-1 w-full relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-link text-slate-400 dark:text-slate-500"></i>
                </div>
                <input type="text" id="urlInput" 
                    placeholder="https://www.hyresult.com/result/..." 
                    class="w-full bg-white dark:bg-black border border-lightBorder dark:border-darkBorder text-slate-900 dark:text-white pl-10 pr-4 py-3 rounded-lg focus:border-hyroxGold outline-none text-sm transition-colors shadow-inner"
                    onkeydown="handleEnter(event)">
            </div>
            <button onclick="fetchAndAnalyze()" id="analyzeBtn"
                class="w-full md:w-auto bg-hyroxGold hover:bg-[#e6c200] text-black font-bold py-3 px-8 rounded-lg text-base md:text-lg tracking-wide transition-transform active:scale-95 flex items-center justify-center gap-2 min-w-[140px] shadow-md">
                <i class="fas fa-bolt"></i> <span id="t-analyze" class="md:inline">ANALYZE</span>
            </button>
        </div>
        <div id="statusLog" class="mt-2 text-center text-xs font-mono min-h-[20px] text-slate-500 dark:text-gray-500 transition-colors">Ready. Enter link and analyze.</div>
    </div>

    <!-- Sporcu Listesi (Chips) -->
    <div id="athletesChips" class="max-w-7xl mx-auto flex flex-wrap gap-2 justify-center mb-6 px-2"></div>

    <!-- Sonuç Tablosu -->
    <div class="max-w-7xl mx-auto w-full overflow-hidden hidden mb-10" id="tableContainer">
        
        <div class="overflow-x-auto pb-4 shadow-xl flex justify-center">
            <!-- Tabloyu ve üst barı saran div. min-w-min ve w-max sayesinde içeriği kadar genişler. -->
            <div class="w-max min-w-full md:min-w-0 flex flex-col">
                
                <!-- Tablo Üst Kontrolleri (Tam tablonun genişliğine sabitlendi) -->
                <div class="flex flex-col sm:flex-row justify-between items-end px-2 py-2 mb-2 gap-3 w-full border-b border-lightBorder dark:border-darkBorder pb-3">
                    <div class="flex flex-col gap-3">
                        <h2 id="t-tableTitle" class="text-base md:text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2 transition-colors">
                            <i class="fas fa-chart-line text-hyroxGold"></i> Detailed Station Analysis
                        </h2>
                        <!-- Filtreleme Butonları -->
                        <div class="flex items-center gap-2">
                            <button id="btnFilterRuns" onclick="toggleFilter('runs')" class="px-3 py-1 rounded text-xs font-bold transition-colors">
                                <span id="t-filterRuns">Runs</span>
                            </button>
                            <button id="btnFilterWorkouts" onclick="toggleFilter('workouts')" class="px-3 py-1 rounded text-xs font-bold transition-colors">
                                <span id="t-filterWorkouts">Workouts</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <button onclick="clearAthletes()" class="text-xs text-slate-500 dark:text-gray-400 hover:text-slate-800 dark:hover:text-white flex items-center gap-1 transition-colors px-3 py-1.5 rounded border border-lightBorder dark:border-darkBorder hover:bg-lightHover dark:hover:bg-darkHover shrink-0">
                            <i class="fas fa-trash-alt"></i> <span id="t-clearList" class="hidden sm:inline">Clear List</span>
                        </button>
                    </div>
                </div>

                <table class="w-max text-left border-collapse min-w-min hyrox-table-border bg-lightPanel dark:bg-darkBg transition-colors">
                    <thead>
                        <tr id="tableHeaderRow" class="text-hyroxGold font-bold text-sm tracking-wide border-b border-lightBorder dark:border-darkBorder bg-lightBg dark:bg-darkBg transition-colors">
                            <!-- Sabit Kolon (Minimal Genişlik) -->
                            <th id="t-split" class="px-3 py-2 md:py-3 w-px whitespace-nowrap pr-4 md:pr-6 sticky-col bg-lightBg dark:bg-darkBg transition-colors shadow-[2px_0_5px_rgba(0,0,0,0.05)] dark:shadow-[2px_0_5px_rgba(0,0,0,0.5)] z-30">
                                Split
                            </th>
                            <!-- Sporcu başlıkları JS ile eklenecek -->
                        </tr>
                    </thead>
                    <tbody id="comparisonBody" class="text-sm font-medium">
                        <!-- Veriler buraya eklenecek -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- FİLTRELEME DURUMU ---
        let showRuns = true;
        let showWorkouts = true;
        const MAX_ATHLETES = 6;

        function toggleFilter(type) {
            if (type === 'runs') showRuns = !showRuns;
            else if (type === 'workouts') showWorkouts = !showWorkouts;
            
            updateFilterUI();
            if (athletes.length > 0) renderTable();
        }

        function updateFilterUI() {
            const btnRuns = document.getElementById('btnFilterRuns');
            const btnWorkouts = document.getElementById('btnFilterWorkouts');
            
            const activeClass = "px-3 py-1 rounded text-xs font-bold transition-all bg-hyroxGold text-black border border-hyroxGold shadow-sm";
            const inactiveClass = "px-3 py-1 rounded text-xs font-bold transition-all bg-transparent text-slate-500 dark:text-gray-500 border border-slate-300 dark:border-darkBorder hover:text-slate-800 dark:hover:text-white";

            btnRuns.className = showRuns ? activeClass : inactiveClass;
            btnWorkouts.className = showWorkouts ? activeClass : inactiveClass;
        }

        // --- ÇOKLU DİL VE TEMA DESTEĞİ ---
        let currentLang = 'EN';
        
        const i18n = {
            TR: {
                subtitle: "Profesyonel Segment Karşılaştırması",
                analyze: "ANALİZ ET",
                ready: "Hazır. Link girin ve analiz edin.",
                tableTitle: "Detaylı İstasyon Analizi",
                clearList: "Listeyi Temizle",
                split: "Split",
                filterRuns: "Koşular",
                filterWorkouts: "Egzersizler",
                loading: "Veriler çekiliyor...",
                errorUrl: "Lütfen geçerli bir Hyrox linki girin.",
                errorParse: "Veri formatı tanınamadı veya boş.",
                errorLimit: `Maksimum ${MAX_ATHLETES} sporcu ekleyebilirsiniz.`,
                errorDuplicate: "Bu sporcu (aynı yarış) zaten listede.",
                success: "Başarılı! Sporcu eklendi.",
                rank1: "1.",
                rank: (val, diff) => `${val}. (+${diff}s)`
            },
            EN: {
                subtitle: "Professional Segment Comparison",
                analyze: "ANALYZE",
                ready: "Ready. Enter link and analyze.",
                tableTitle: "Detailed Station Analysis",
                clearList: "Clear List",
                split: "Split",
                filterRuns: "Runs",
                filterWorkouts: "Workouts",
                loading: "Fetching data...",
                errorUrl: "Please enter a valid Hyrox link.",
                errorParse: "Data format unrecognized or empty.",
                errorLimit: `You can compare up to ${MAX_ATHLETES} athletes at a time.`,
                errorDuplicate: "This athlete (from the same event) is already in the list.",
                success: "Success! Athlete added.",
                rank1: "1st",
                rank: (val, diff) => {
                    let suffix = "th";
                    if (val === 2) suffix = "nd";
                    else if (val === 3) suffix = "rd";
                    return `${val}${suffix} (+${diff}s)`;
                }
            }
        };

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            const icon = document.getElementById('themeIcon');
            
            if(isDark) {
                icon.className = 'fas fa-moon text-hyroxGold';
            } else {
                icon.className = 'fas fa-sun text-slate-700';
            }
            updateFilterUI(); // Tema değiştiğinde filtre renklerini de güncelle
            if (athletes.length > 0) renderTable(); 
        }

        function toggleLang() {
            currentLang = currentLang === 'TR' ? 'EN' : 'TR';
            
            const safeSetText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            };

            safeSetText('langBtnText', currentLang);
            safeSetText('t-subtitle', i18n[currentLang].subtitle);
            safeSetText('t-analyze', i18n[currentLang].analyze);
            safeSetText('t-clearList', i18n[currentLang].clearList);
            safeSetText('t-split', i18n[currentLang].split);
            safeSetText('t-filterRuns', i18n[currentLang].filterRuns);
            safeSetText('t-filterWorkouts', i18n[currentLang].filterWorkouts);

            const tableTitle = document.getElementById('t-tableTitle');
            if (tableTitle) {
                tableTitle.innerHTML = `<i class="fas fa-chart-line text-hyroxGold"></i> ${i18n[currentLang].tableTitle}`;
            }

            const logEl = document.getElementById('statusLog');
            if(logEl) {
                if(logEl.textContent.includes('Hazır') || logEl.textContent.includes('Ready') || logEl.textContent.includes('Başarılı') || logEl.textContent.includes('Success')) {
                    logEl.textContent = i18n[currentLang].ready;
                }
            }

            if (athletes.length > 0) renderTable();
        }

        // --- VERİ YAPISI ---
        let athletes = [];
        
        const jsonMapping = {
            "Running 1": { key: "Run 1", label: "Running 1", isRun: true },
            "1000m SkiErg": { key: "SkiErg", label: "1000m SkiErg", isRun: false },
            "Running 2": { key: "Run 2", label: "Running 2", isRun: true },
            "50m Sled Push": { key: "Sled Push", label: "50m Sled Push", isRun: false },
            "Running 3": { key: "Run 3", label: "Running 3", isRun: true },
            "50m Sled Pull": { key: "Sled Pull", label: "50m Sled Pull", isRun: false },
            "Running 4": { key: "Run 4", label: "Running 4", isRun: true },
            "80m Burpee Broad Jump": { key: "Burpee Broad Jump", label: "80m Burpee Broad Jump", isRun: false },
            "Running 5": { key: "Run 5", label: "Running 5", isRun: true },
            "1000m Row": { key: "Row", label: "1000m Row", isRun: false },
            "Running 6": { key: "Run 6", label: "Running 6", isRun: true },
            "200m Farmers Carry": { key: "Farmers Carry", label: "200m Farmers Carry", isRun: false },
            "Running 7": { key: "Run 7", label: "Running 7", isRun: true },
            "100m Sandbag Lunges": { key: "Sandbag Lunges", label: "100m Sandbag Lunges", isRun: false },
            "Running 8": { key: "Run 8", label: "Running 8", isRun: true },
            "Wall Balls": { key: "Wall Balls", label: "Wall Balls", isRun: false }
        };

        const stationOrder = [
            "Run 1", "SkiErg", "Run 2", "Sled Push", "Run 3", "Sled Pull", "Run 4", "Burpee Broad Jump", 
            "Run 5", "Row", "Run 6", "Farmers Carry", "Run 7", "Sandbag Lunges", "Run 8", "Wall Balls"
        ];

        // --- YARDIMCI FONKSİYONLAR ---
        
        // XSS Önlemi
        function escapeHTML(str) {
            if (!str) return "";
            return str.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatSeconds(sec) {
            if (sec === null || sec === undefined || isNaN(sec) || sec === Infinity) return "-";
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function timeToSeconds(timeStr) {
            if (!timeStr || timeStr === "-") return Infinity;
            const parts = timeStr.split(':').map(Number);
            if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
            if (parts.length === 2) return parts[0] * 60 + parts[1];
            return Infinity;
        }

        function log(msg, type = 'info') {
            const el = document.getElementById('statusLog');
            el.textContent = msg; // innerHTML yerine textContent kullanımı (Güvenlik)
            
            if (type === 'error') el.className = "mt-3 text-center text-xs font-mono min-h-[20px] text-red-500 dark:text-red-400 transition-colors";
            else if (type === 'success') el.className = "mt-3 text-center text-xs font-mono min-h-[20px] text-green-600 dark:text-green-400 transition-colors";
            else el.className = "mt-3 text-center text-xs font-mono min-h-[20px] text-slate-500 dark:text-hyroxGold transition-colors";
        }

        function handleEnter(e) {
            if (e.key === 'Enter') fetchAndAnalyze();
        }

        // --- TEMEL İŞLEM ---
        async function fetchAndAnalyze() {
            if (athletes.length >= MAX_ATHLETES) {
                log(i18n[currentLang].errorLimit, "error");
                return;
            }

            let url = document.getElementById('urlInput').value.trim();
            const btn = document.getElementById('analyzeBtn');

            if (!url) {
                log(i18n[currentLang].errorUrl, "error");
                return;
            }

            if (!url.includes("tab=")) url += (url.includes("?") ? "&" : "?") + "tab=workouts";

            btn.disabled = true;
            btn.innerHTML = `<div class="animate-spin border-2 border-black border-t-transparent rounded-full w-5 h-5"></div>`;
            log(i18n[currentLang].loading, "info");

            try {
                const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                
                if (!response.ok) throw new Error(`Sunucu Hatası / Server Error: ${response.status}`);
                const html = await response.text();
                
                if (!html || (!html.includes("<!DOCTYPE") && !html.includes("<html"))) {
                    throw new Error("Geçersiz veri formatı / Invalid format");
                }

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");

                let name = "Bilinmeyen Sporcu";
                let eventName = "";

                const h1 = doc.querySelector('h1');
                if (h1) name = h1.textContent.trim();

                const eventLink = doc.querySelector('a[href^="/event/"]:not([href*="?"])');
                if (eventLink) {
                    eventName = eventLink.textContent.replace(/\s+/g, ' ').trim();
                } else {
                    const title = doc.querySelector('title')?.textContent || "";
                    if (title.includes(" at ")) {
                        eventName = title.split(" at ")[1].split(" • ")[0].trim();
                    }
                }

                // Kopya Kontrolü (Aynı isim ve aynı yarışma engellenir)
                const isDuplicate = athletes.some(a => a.name === name && a.event === eventName);
                if (isDuplicate) {
                    throw new Error(i18n[currentLang].errorDuplicate);
                }

                const times = {};
                let dataFound = false;
                
                // Güvenli regex arayışı
                const regexPattern = /(?:\\"|")name(?:\\"|"):(?:\\"|")([^"]+?)(?:\\"|"),(?:.*?)(\\?)"time(?:\\"|"):(\d+)/g;
                const matches = [...html.matchAll(regexPattern)];

                matches.forEach(match => {
                    const rawName = match[1]; 
                    const seconds = parseInt(match[3]);
                    if (jsonMapping[rawName] && !isNaN(seconds)) {
                        times[jsonMapping[rawName].key] = formatSeconds(seconds);
                        dataFound = true;
                    }
                });

                if (dataFound) {
                    athletes.push({ id: Date.now(), name: name, event: eventName, times: times });
                    renderTable();
                    log(i18n[currentLang].success, "success");
                    document.getElementById('urlInput').value = "";
                } else {
                    throw new Error(i18n[currentLang].errorParse);
                }

            } catch (err) {
                // Temiz hata mesajı gösterimi
                log(err.message.replace('Error: ', ''), "error");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-bolt"></i> <span class="md:inline">${i18n[currentLang].analyze}</span>`;
            }
        }

        // --- UI GÜNCELLEME ---
        function clearAthletes() {
            athletes = [];
            renderTable();
            log(i18n[currentLang].ready, "info");
        }

        function removeAthlete(id) {
            athletes = athletes.filter(a => a.id !== id);
            renderTable();
        }

        function renderTable() {
            const tableContainer = document.getElementById('tableContainer');
            const tableHeaderRow = document.getElementById('tableHeaderRow');
            const tbody = document.getElementById('comparisonBody');
            const chipsContainer = document.getElementById('athletesChips');

            if (athletes.length === 0) {
                tableContainer.classList.add('hidden');
                chipsContainer.innerHTML = "";
                return;
            }
            tableContainer.classList.remove('hidden');

            // 1. Üstteki sporcu etiketleri
            chipsContainer.innerHTML = athletes.map(a => `
                <div class="bg-lightPanel dark:bg-darkPanel text-slate-800 dark:text-gray-200 px-3 py-1.5 rounded border border-lightBorder dark:border-darkBorder flex items-center gap-2 shadow-sm">
                    <span class="w-2 h-2 rounded-full bg-hyroxGold"></span>
                    <div class="flex flex-col overflow-hidden max-w-[120px]">
                        <span class="font-bold text-xs truncate leading-tight" title="${escapeHTML(a.name)}">${escapeHTML(a.name.split(' ')[0])}</span>
                        <span class="text-[9px] text-slate-500 dark:text-gray-500 uppercase truncate" title="${escapeHTML(a.event)}">${escapeHTML(a.event)}</span>
                    </div>
                    <button onclick="removeAthlete(${a.id})" class="text-slate-400 hover:text-red-500 transition-colors ml-1" title="Remove">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `).join('');

            // 2. Tablo Başlığı
            let headerHtml = `
                <th id="t-split" class="px-3 py-2 md:py-3 w-px whitespace-nowrap pr-4 md:pr-6 sticky-col bg-lightBg dark:bg-darkBg border-b border-lightBorder dark:border-darkBorder transition-colors shadow-[2px_0_5px_rgba(0,0,0,0.05)] dark:shadow-[2px_0_5px_rgba(0,0,0,0.5)] z-30">
                    ${i18n[currentLang].split}
                </th>`;
            
            athletes.forEach(a => {
                headerHtml += `
                    <th class="dyn-col py-1.5 md:py-2 text-center bg-lightBg dark:bg-darkBg border-b border-lightBorder dark:border-darkBorder relative align-bottom transition-colors">
                        <div class="flex flex-col items-center">
                            <span class="text-slate-800 dark:text-white font-bold text-sm md:text-base leading-tight truncate w-full" title="${escapeHTML(a.name)}">${escapeHTML(a.name.split(' ')[0])}</span>
                            <span class="text-[9px] text-slate-500 dark:text-gray-500 font-normal mt-0.5 truncate w-full" title="${escapeHTML(a.event)}">${escapeHTML(a.event)}</span>
                        </div>
                    </th>`;
            });
            
            tableHeaderRow.innerHTML = headerHtml;

            // 3. Tablo Gövdesi
            let bodyHtml = "";
            let workoutCounter = 1;

            stationOrder.forEach((stationKey) => {
                let stationInfo = null;
                for (const key in jsonMapping) {
                    if (jsonMapping[key].key === stationKey) {
                        stationInfo = jsonMapping[key];
                        break;
                    }
                }
                if (!stationInfo) return;

                // FİLTRELEME MANTIĞI
                if (!showRuns && stationInfo.isRun) return;
                if (!showWorkouts && !stationInfo.isRun) {
                    workoutCounter++; // Egzersiz sırasının kaymaması için sayacı artır, satırı çizme
                    return;
                }

                let stationTimes = athletes.map(a => ({ id: a.id, time: timeToSeconds(a.times[stationKey]) }))
                                           .filter(x => x.time !== Infinity);
                
                stationTimes.sort((a, b) => a.time - b.time);

                let ranks = {};
                let currentRank = 1;
                let minSec = stationTimes.length > 0 ? stationTimes[0].time : Infinity;

                for (let i = 0; i < stationTimes.length; i++) {
                    if (i > 0 && stationTimes[i].time > stationTimes[i-1].time) {
                        currentRank = i + 1;
                    }
                    ranks[stationTimes[i].id] = {
                        rank: currentRank,
                        diff: stationTimes[i].time - minSec
                    };
                }

                bodyHtml += `<tr class="border-b border-lightBorder dark:border-darkBorder hover:bg-lightHover dark:hover:bg-darkHover transition-colors">`;
                
                // İstasyon Adı Kolonu
                if (stationInfo.isRun) {
                    bodyHtml += `
                        <td class="px-2 py-1 md:py-1.5 w-px whitespace-nowrap sticky-col bg-lightPanel dark:bg-darkBg transition-colors shadow-[2px_0_5px_rgba(0,0,0,0.02)] dark:shadow-[2px_0_5px_rgba(0,0,0,0.2)]">
                            <div class="pr-2 md:pr-4 ml-4 md:ml-6">
                                <span class="text-slate-600 dark:text-gray-400 font-normal text-xs md:text-sm">${escapeHTML(stationInfo.label)}</span>
                            </div>
                        </td>
                    `;
                } else {
                    bodyHtml += `
                        <td class="px-2 py-1 md:py-1.5 w-px whitespace-nowrap sticky-col bg-lightPanel dark:bg-darkBg transition-colors shadow-[2px_0_5px_rgba(0,0,0,0.02)] dark:shadow-[2px_0_5px_rgba(0,0,0,0.2)]">
                            <div class="flex items-center gap-1.5 md:gap-2 pr-2 md:pr-4">
                                <div class="bg-hyroxGold text-black font-bold text-xs px-1 md:px-1.5 py-0.5 min-w-[20px] md:min-w-[24px] text-center rounded-sm shrink-0">
                                    ${workoutCounter.toString().padStart(2, '0')}
                                </div>
                                <span class="text-slate-800 dark:text-white font-bold text-xs md:text-sm">${escapeHTML(stationInfo.label)}</span>
                            </div>
                        </td>
                    `;
                    workoutCounter++;
                }

                // Sporcu Verileri
                athletes.forEach(a => {
                    const timeStr = a.times[stationKey] || "-";
                    const seconds = timeToSeconds(timeStr);
                    const rankData = ranks[a.id];
                    
                    let rankText = "";
                    let barColorClass = "bg-slate-400 dark:bg-slate-600";
                    let percent = 0;
                    
                    // Güvenli Yüzde Hesaplama (0'a bölünme önlemi ve clamp)
                    if (seconds !== Infinity && minSec !== Infinity) {
                         if (seconds === 0) {
                             percent = 100;
                         } else {
                             percent = (minSec / seconds) * 100;
                         }
                         percent = Math.max(0, Math.min(100, percent));
                    }

                    if (rankData && athletes.length > 1) {
                        if (rankData.rank === 1) {
                            barColorClass = "bg-hyroxGold";
                            rankText = i18n[currentLang].rank1;
                        } else if (rankData.rank === 2) {
                            barColorClass = "bg-rankSilver";
                            rankText = i18n[currentLang].rank(2, rankData.diff);
                        } else if (rankData.rank === 3) {
                            barColorClass = "bg-rankBronze";
                            rankText = i18n[currentLang].rank(3, rankData.diff);
                        } else {
                            barColorClass = "bg-slate-400 dark:bg-slate-600";
                            rankText = i18n[currentLang].rank(rankData.rank, rankData.diff);
                        }
                    } else if (rankData && athletes.length === 1) {
                         barColorClass = "bg-hyroxGold";
                         percent = 100;
                    }

                    // Barın render edilmesi
                    bodyHtml += `
                        <td class="dyn-col py-1 md:py-1.5 text-center align-middle">
                            ${timeStr !== '-' ? `
                                <div class="relative w-full h-10 md:h-12 bg-slate-300 dark:bg-slate-800 rounded overflow-hidden shadow-inner border border-slate-300 dark:border-slate-700">
                                    <div class="absolute top-0 left-0 h-full ${barColorClass} transition-all duration-500 opacity-90" style="width: ${percent}%"></div>
                                    <div class="absolute inset-0 flex flex-col items-center justify-center text-outline z-10">
                                        <span class="font-sport text-base md:text-lg tracking-wide text-white font-bold leading-none mt-0.5">${timeStr}</span>
                                        ${rankText ? `<span class="text-[9px] md:text-[10px] text-gray-100 font-bold leading-none mt-0.5 tracking-wide">${rankText}</span>` : ''}
                                    </div>
                                </div>
                            ` : `
                                <div class="font-sport text-lg md:text-xl text-slate-500">-</div>
                            `}
                        </td>
                    `;
                });
                
                bodyHtml += `</tr>`;
            });
            tbody.innerHTML = bodyHtml;
        }

        // İlk Yüklemede Arayüzü Güncelle
        updateFilterUI();
    </script>
</body>
</html>
